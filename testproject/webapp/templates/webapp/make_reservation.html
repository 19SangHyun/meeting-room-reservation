{% extends 'webapp/base.html' %}

{% block content %}
<h2>{{ room.name }} 예약하기</h2>

<style>
  .container {
    display: flex;
    gap: 30px;
  }
  .reservation-form {
    flex: 1;
  }
  .reservation-list {
    flex: 1;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 6px;
    background-color: #f9f9f9;
    max-height: 400px;
    overflow-y: auto;
  }
  .reservation-list h3 {
    margin-top: 0;
  }
</style>

<div class="container">
  <div class="reservation-form">
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">예약하기</button>
    </form>

    <div id="overlap-warning" style="color: red; margin-top: 10px;"></div>
  </div>

  <div class="reservation-list">
    <h3>현재 예약 현황</h3>
    {% if existing_reservations %}
      <ul id="reservation-list-ul"></ul>
    {% else %}
      <p>예약된 시간이 없습니다.</p>
    {% endif %}
  </div>
</div>

<a href="{% url 'room_detail' room.id %}">뒤로가기</a>

<script>
  const existingReservations = JSON.parse('{{ existing_reservations|escapejs }}');
  const reservationListUl = document.getElementById('reservation-list-ul');
  const warningDiv = document.getElementById('overlap-warning');

  // 예약 현황 목록 출력
  if (reservationListUl) {
    existingReservations.forEach(res => {
      const li = document.createElement('li');
      li.textContent = `${res.date}: ${res.start_time} ~ ${res.end_time}`;
      reservationListUl.appendChild(li);
    });
  }

  // 날짜/시간 필드 참조
  const dateInput = document.querySelector('input[name="date"]');
  const startInput = document.querySelector('input[name="start_time"]');
  const endInput = document.querySelector('input[name="end_time"]');

  function checkOverlap() {
    warningDiv.textContent = '';
    const selectedDate = dateInput.value;
    const startTime = startInput.value;
    const endTime = endInput.value;

    if (!selectedDate || !startTime || !endTime) return;

    for (const res of existingReservations) {
      if (res.date === selectedDate) {
        if (!(endTime <= res.start_time || startTime >= res.end_time)) {
          warningDiv.textContent = `경고: ${res.date} ${res.start_time} ~ ${res.end_time} 예약이 이미 있습니다. 다른 시간으로 선택하세요.`;
          break;
        }
      }
    }
  }

  dateInput.addEventListener('change', checkOverlap);
  startInput.addEventListener('change', checkOverlap);
  endInput.addEventListener('change', checkOverlap);
</script>

{% endblock %}






